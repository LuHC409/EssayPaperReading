
# 分子结构识别任务与 MolScribe 模型解析
## 参考文献

- [MolScribe: Robust Molecular Structure Recognition with Image-To-Graph Generation](https://arxiv.org/pdf/2205.14311)
## 一、任务背景与挑战

分子结构识别任务要求从二维分子图像中提取出准确的分子结构信息。由于化学文献中存在多种绘图风格和绘图约定，这给自动化处理带来了极大挑战。不同风格可能导致模型难以统一理解各类符号和布局。

## 二、MolScribe 模型简介

MolScribe 是一种从图像直接生成分子图结构的模型，具有三大核心设计：

1. 显式预测原子和化学键及其几何布局。
2. 融合化学知识（符号约束）。
3. 利用分子图结构推断手性中心（如 R/S 构型），并解析官能团缩写（如 Me 表示甲基）。

MolScribe 训练阶段使用多种风格图像进行数据增强，以提升模型在不同绘图风格下的鲁棒性。

## 三、MolScribe 架构设计与优势

- image-to-graph 架构。
- 支持原子级别图像对齐，便于化学家校验。
- 结合规则方法的可解释性与神经网络的灵活性。

## 四、实验结果与优势

- 合成与真实图像上性能优越。
- 基准测试中准确率为 76%–93%。
- 输出支持置信估计与原子对齐。

## 五、现有方法对比

### image-to-SMILES

- 使用 CNN 提取特征 + RNN 解码。
- 优点：可端到端训练，适应多种图像风格。
- 缺点：难以融合化学规则；立体识别差。

### ChemGrapher / MolMiner

- 分阶段：分割识别原子和键 + 启发式拼接。
- 优点：可加入化学规则。
- 缺点：流程复杂，误差易累积。

### MolScribe 的优势

- 统一的 end-to-end 图生成架构。
- 显式预测原子/键/坐标关系，便于规则嵌入。
- 无需启发式拼接，降低错误传递。

## 六、任务定义

- 输入：单分子的 PNG 或 JPG 图像。
- 输出：二维分子图 G = (A, B)
  - A = {a1, a2, ..., an}：原子集合。
  - B ⊂ A × A × T：键集合（连接关系 + 键类型）。
  - T：键类型集合，如单键、双键、三键、芳香键、楔形键等。

## 七、MolScribe 模型原理解析

### 1. 总体架构

- 输入：分子图像
- 输出：二维结构图 G = (A, B)
  - 原子 ai = (li, xi, yi)
  - 条件建模概率：P(G | I) = P(A | I) * P(B | A, I)

### 2. 原子预测器（Atom Predictor）

- 使用自回归生成：
  - P(A | I) = ∏ P(ai | A<i, I)
- 原子序列形式：SA = [l1, x1, y1, ..., ln, xn, yn]
- 坐标离散化：
  - x^i = floor(xi / W * nbins)
  - y^i = floor(yi / H * nbins)

### 3. 化学键预测器（Bond Predictor）

- 每对原子 (ai, aj) 预测连接类型。
- 使用隐藏状态拼接后送入前馈网络：
  - P(B | A, I) = ∏ P(b_ij | A, I)
- 支持的键类型包括：无连接、单键、双键、三键、芳香键、实心楔、虚线楔。

### 4. 对称性与方向处理（楔形键）

- 对称键合并概率：
  - P^(bij = t) = 0.5 * (P(bij = t) + P(bji = t))
- 非对称键（如实心楔 ↔ 虚线楔）也采用联合估计方式。

### 5. 分子图构建与导出

- 将预测结果构造成分子图结构。
- 支持导出：
  - MOLfile（含2D坐标）
  - SMILES（结构表达）

## 八、MolScribe 如何处理立体化学问题

### 什么是立体化学？

- 描述分子中原子的三维排布。
- 包括：
  - 手性中心（R/S）
  - 顺反异构（cis/trans）

### 为什么神经网络难以处理？

- 图像中的立体信息通过楔形键表示。
- SMILES 表达立体需依赖连接顺序，而这在图像中不明确。

### MolScribe 的解决方案

#### 手性判断流程：

1. 识别潜在手性碳原子。
2. 获取其相邻键和原子坐标。
3. 根据空间位置判断连接顺序。
4. 使用 RDKit + CIP 规则判断其为 [C@H] 或 [C@@H]。

#### 顺反异构判断：

1. 找出双键两端原子。
2. 判断空间布局位置。
3. 加入斜杠方向构建 SMILES：
   - C/C=C/C → trans
   - C/C=C\C → cis

### 优势总结

| 方法 | 特点 | 是否能识别立体信息 |
|------|------|--------------------|
| 传统 image-to-SMILES | 仅基于像素，猜测结构 | 否 ❌ |
| MolScribe | 显式建模 + 规则推断 | 是 ✅ |

## 九、缩写结构展开（超级原子）

### 步骤一：识别超级原子

- 如 "CO₂Et" 被识别为超级原子节点。

### 步骤二：字符级拆分

- 将字符串拆解为原子序列（不依赖固定词表）。

### 步骤三：贪心算法展开结构

示例伪代码：

```python
L ← expand_subscripts(f)
acur ← L[0]
Gs.add_atom(acur)

for a in L[1:]:
  if acur.implicit_valence == 0:
    return FAILURE
  Gs.add_atom(a)
  if a.valence <= acur.implicit_valence:
    Gs.add_bond(acur, a, order = a.valence)
  else:
    Gs.add_bond(acur, a, order = acur.implicit_valence)
  acur ← a

G.replace(as, Gs)
```

## 十、数据增强策略（Data Augmentation）

### 分子结构增强

1. 官能团缩写（如 Me, COOH）。
2. 插入 R 基团（R, R1, R' 等）。
3. 随机字符超级原子（如 XY3，提升 OCR 泛化）。

### 图像风格增强

- 字体变化、线宽、旋转、裁剪、噪声模拟等。
- 模拟出版图、扫描件、手绘风格等多种实际图像形式。

## 十一、模型实现细节

### 图像编码器

- 使用 Swin Transformer-B（88M 参数）
- 图像统一为 384x384 分辨率

### 解码器

- 6 层 Transformer 解码器（8 头注意力，每层维度 256）
- 使用正弦位置编码，dropout = 0.1

### 化学键预测器

- 两层前馈网络（ReLU 激活）
- 输入为原子隐藏状态拼接

### 训练细节

- 使用 teacher forcing
- 联合训练所有模块
- 学习率策略：warmup + cosine decay
  - 初始最大学习率：4e-4
  - warmup 前 5%
- 批大小：128，训练轮数：30 epoch
- 标签平滑参数 ε = 0.1
- 原子坐标离散化参数 nbins = 64

## 十二、推理与评估基准

### 推理阶段

- 原子预测使用贪心解码（逐个生成）
- 然后进行键预测（全连接对分类）


## 十三、局限与未来方向

**MolScribe** 是图像结构识别的一项重要进展，但目前仍存在一定局限。

### ❗ 当前模型的局限性

- 仅支持识别 **单个分子结构**  
  （不适用于复杂反应式或多个分子组合的构图）

---

### 🔜 未来发展方向

#### 1. 支持手绘分子识别

- 手绘图形中的字体和线条更不规则，识别难度更高  
- 模型需进一步提升 **OCR 能力** 与 **容错机制**

#### 2. 识别复杂 Markush 结构

- 当前仅能处理简单 R-group（如 `"R1"`, `"R2"`），但以下结构目前无法处理：
  - R-group 可连接在 **环上任意原子**（位置可变性）
  - **重复结构块**（例如 `(CH2)n`，频率可变性）
- 这类结构 **无法用 SMILES 或 MOL 文件准确表达**

✅ **解决思路**：
- 设计一种新的、可机器读写的分子结构表示方式（如 *Markush graph language*）

---

### ✅ 模型的关键设计优势

#### 1. 联合预测原子、键与坐标布局

- 不像 image-to-SMILES 模型那样仅输出字符串  
- **MolScribe** 直接构造结构图，预测包括：
  - 原子的 SMILES 标签（如 `"C"`、`"[O-]"`）
  - 图中坐标位置
  - 每对原子间的键类型（单键、双键等）

#### 2. 数据增强以应对图像风格多样性

- 采用多种增强方式训练模型：
  - 合成图像
  - 图像扰动
  - 缩写结构插入
  - R 基团替换等
- 显著提升模型鲁棒性，适应期刊、专利、手绘等多样图像风格

#### 3. 可解释性强

- 输出结构包含坐标信息，可在图像上 **标注预测位置**
- 化学家可直观看图修正，提升人工校验效率
- 加入了 **手性判断** 和 **缩写结构展开** 等规则机制，让模型更“懂化学”
