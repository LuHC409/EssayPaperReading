---
title: "subgrapher"
author: "Haocheng Lu"
date: "2025-05-06"
header-includes:
  - \usepackage{xeCJK}
  - \setCJKmainfont{Noto Serif CJK SC}
geometry: margin=1in
---

## 引言 (Introduction)

自动将专利和文献中以图像形式呈现的分子结构转为可检索的指纹，是加速药物与材料发现的关键。传统的 OCSR 方法虽能生成 SMILES 或分子图，但对绘图风格的多样性、图像质量下降和包含 Markush 等非标准元素的结构仍然敏感，而且完整分子重建往往超出了很多检索与预测任务的需求。SubGrapher 创新性地跳过 SMILES 重建，直接从图像中识别功能团与碳骨架，构建子结构图并生成视觉分子指纹（SVMF），提高了对多种分子绘制风格的鲁棒性，并在检索性能上显著优于最先进的 OCSR+指纹 组合。

---

## 方法概述 (Method Overview)

SubGrapher 是一套端到端的视觉指纹提取系统，能够直接将化学结构图像转化为高效、可检索的子结构指纹（visual molecular fingerprint）。整体流程可划分为三个核心模块，它们在数据流上紧密衔接、协同工作：

1. **子结构实例分割**  
   同时启动两套 Mask‑R‑CNN 实例分割网络，分别负责识别“官能团”和“碳骨架”两大类别，确保子结构检测的全面性与精度。

2. **子结构图构建**  
   将各子结构实例的像素掩码映射为图中节点，依据掩码扩张后边界框的几何关系和空间临近度添加加权无向边，最终构建出反映分子拓扑与空间布局的信息图。

3. **指纹生成（SVMF）**  
   在子结构图基础上构建上三角矩阵，矩阵对角记录各子结构出现频次，非对角则依据子结构间最短路径距离进行加权累加，最后将矩阵展平为稀疏向量形式，形成可用于向量检索的视觉指纹。

---

### 6.1 子结构实例分割模型

- **双网络设计**  
  - **功能团网络**：覆盖 1 534 类专家预定义官能团（如 –OH、–NO₂、吡啶环等），针对常见活性位点进行了精细化标注与训练。  
  - **碳骨架网络**：识别 27 种典型碳链与环状框架，用于补全功能团之间的结构连接。  
  - 两者互不干扰：功能团网络无需关注长链细节，骨架网络不受多种官能团干扰，从而降低训练冲突，加速收敛。

**为什么这样设计？**  
- 功能团和骨架在化学语义层面上具有不同的纹理与拓扑特征，分离训练可让网络各司其职，提升精度与效率。  
- 双网络方案减少了单一模型在多任务学习中常见的互相干扰问题，使得收敛更快、参数利用率更高。

**可改进之处**  
- 考虑在功能团和骨架网络之间引入轻量级注意力机制，实现信息交互，进一步提升连接预测的准确性。  
- 探索多尺度融合，将不同分辨率下的特征进行融合，以捕捉更丰富的子结构信息。

---

### 6.2 子结构图构建

1. **节点定义**  
   每个分割出的功能团或骨架实例对应一个节点，属性包括：类别 ID、检测置信度、像素掩码与最小外接矩形（bounding box）。

2. **图清理**  
   对检测结果进行冗余去除：若两节点 IOU > 0.8 且类别相同，则合并为单一节点，剔除重复检测，减少噪声。

3. **边构建策略**  
   - **边界框扩张**：以对角线长度 $$D$$ 为基准，按 $$0.1 \times D$$ 向四周扩张，生成扩张框；  
   - **重叠连边**：若两扩张框重叠面积 > 0，则添加无向边；  
   - **近邻连边**：若不重叠但中心间距 < 3 px，同样添加边，以捕捉平面构象下的空间邻近信息。

4. **后处理**  
   删除低置信度且无连接的孤立节点，合并高重叠节点，最终输出一张加权的无向图，既保留了拓扑结构，也反映了空间分布。

**为什么这样构建子结构图？**  
- 精细的图构建过程保证了后续基于图的路径计算与特征提取能准确反映分子内部的真实连接关系。  
- 扩张框与近邻连接策略兼顾了结构连通性与空间距离，使图在平面渲染失真时依然稳定可靠。

**可改进之处**  
- 动态调节扩张系数（例如根据节点大小或类别差异调整），以适应不同尺寸子的分子结构。  
- 引入图神经网络（GNN）中的注意力边权重学习，自动优化边的构建与权重赋值。

---

### 6.3 子结构视觉分子指纹（SVMF）及示例

- **矩阵构造**  
  - 设总子结构数 $$n=1,561$$（1 534 功能团 + 27 骨架），构建 $$n\times n$$ 上三角矩阵 $$F$$。  
  - **对角线元素**：  
    $$
    f_{ii} = h_1 \times n_i,\quad h_1 = 10,\; n_i=子结构 i 的实例数
    $$  
  - **非对角元素**：  
    $$
    f_{ij} = \sum_{a}\sum_{b} h_2(d(i_a,j_b)),\quad
    h_2(d)=
    \begin{cases}
    2.0 & d=1,\\
    0.5 & d=2,\\
    0.125 & d=3,\\
    0.0078 & d=4,\\
    0 & d>4,
    \end{cases}
    $$  
    其中 $$d$$ 为子结构图中最短路径跳数；对于碳骨架对，再在该值上除以 2。

- **乙醇示例**  
  1. 节点：CH₃、CH₂、OH，各出现 1 次  
  2. 最短路径：CH₃–CH₂ $$d=1$$，CH₂–OH $$d=1$$，CH₃–OH $$d=2$$  
  3. 对角线值：10、10、10；非对角值：2、2、0.5  
  4. 上三角矩阵：  
     $$
     \begin{bmatrix}
     10 & 2 & 0.5 \\
     0  & 10 & 2   \\
     0  & 0  & 10
     \end{bmatrix}
     $$  
  5. 展平并取整后向量：$$[10, 2, 1, 10, 2, 10]$$，以稀疏索引形式存储。

**为什么这样设计指纹？**  
- 上三角矩阵保证了指纹表示的对称性与稀疏性，减少存储冗余，并保留完整拓扑信息。  
- 不同跳数的权重函数 $$h_2(d)$$ 能明确区分近邻与远邻对分子活性位点识别的贡献度。

**可改进之处**  
- **权重优化**：通过学习算法（如贝叶斯优化或神经网络）自动调节 $$h_1$$ 与 $$h_2$$ 参数，以适配更多化学反应类型。  
- **多尺度距离**：结合三维空间距离或化学键类型（单、双、芳香键）来丰富相互作用权重，提升区分度。  
- **压缩编码**：采用降维或哈希技术（如 PCA、LSH）进一步压缩指纹向量，加快后续检索速度。

---

### 6.4 分子检索

- **指纹入库**：将所有生成的视觉指纹预先存入向量数据库。  
- **相似度度量**：计算两指纹向量的欧氏范数归一化距离  
  $$
    \frac{\|f_1 - f_2\|}{\|f_1 + f_2\|}
  $$  
- **快速检索**：借助 FAISS 等向量检索引擎，实时返回最相似的分子图像及对应分子信息。

**为什么这样检索？**  
- 预计算并离线入库能大幅降低在线检索延迟，满足高并发查询需求。  
- 归一化距离度量有效抵消指纹大小差异，使得不同大小分子的相似度评估更公平。

**可改进之处**  
- 尝试其它距离指标（如余弦相似度、曼哈顿距离）并结合多指标融合，以提升检索鲁棒性。  
- 利用层次化索引或混合检索架构（先粗后细），进一步缩减候选集，提高检索效率。

---

### 6.5 子结构覆盖（词表设计与评估）

为了让视觉指纹既能覆盖化学空间的多样性，又能保持高区分度，我们在「覆盖性」「稀疏性」「区分度」三者之间做了如下设计与评估：

#### 目标与权衡
- **覆盖性 (Coverage)**  
  确保在绝大多数有机分子中都能匹配到若干子结构，尤其是关键活性位点和常见骨架。  
- **稀疏性 (Sparsity)**  
  控制子结构总数，避免指纹向量过度密集，既节省存储又提高检索速度。  
- **区分度 (Discriminability)**  
  子结构不能过于相似或重叠，以免不同分子“指纹撞衫”，影响检索精度。

#### 子结构候选生成
1. **初步列表**  
   - 专家手工罗列 C、O、N、S、B、P 等元素组成的短链（≤5 原子）、环状、典型官能团组合。  
2. **PubChem 频次过滤**  
   - 对每个候选子结构家族做子结构检索，仅保留出现 ≥ 1 000 次的化学合理族，剔除罕见或非典型结构。  
3. **相似度聚类去冗余**  
   - 基于 ECFP 等化学指纹对候选结构进行聚类，同簇内保留代表性最强的一小部分，进一步降低冗余度。

#### 碳骨架候选设计
- **选取范围**  
  包括 3–6 个碳的直链、支链及环（单/双/三键），确保能够连接各种官能团。  
- **重叠度评估**  
  在子结构图上模拟骨架–官能团的邻接率，剔除那些既“过于泛化”又“对官能团覆盖无实质贡献”的骨架。

#### 覆盖质量评估
1. **数据集回测**  
   - 在百万级 PubChem 子集上统计“每个分子至少匹配到 k=3 个子结构”的匹配率，目标 ≥ 95%。  
2. **指纹区分度**  
   - 计算同分子 vs. 不同分子的指纹相似度分布（intra-/inter-），要求两者均值差 Δ ≥ 0.2。  
3. **近似异构体验证**  
   - 对一组立体异构体（如 L‑乳酸 vs. D‑乳酸）进行检索测试，确保指纹相似度 < 1.0，可区分镜像异构。

#### 最终词表规模与统计
- **功能团**：1 534 种  
- **碳骨架**：27 种  
- **整体统计**  
  - 平均每分子可匹配子结构数量：≈ 8.7  
  - 指纹向量稀疏度：≈ 0.56%  
  - 向量长度（L₂ 范数）：≈ 4×10⁻³

---

### 6.6 训练数据集生成

1. **分子采样**：从 PubChem 随机提取 SMILES 序列，保证化学空间多样性。  
2. **图像渲染**：利用 RDKit 将 SMILES 转为高分辨率 SVG，并导出位图图像。  
3. **掩码自动生成**：  
   - 通过 RDKit API 精确识别子结构原子与键；  
   - 在 SVG 坐标上定位元素，输出像素级 mask。  
4. **Markush 结构支持**：  
   - 基于 CXSMILES 构造 R‑Group 变体，添加位置/频次标注；  
   - 使用 CDK 渲染 Markush 图，实现对应掩码生成。

最终生成百万级多样化、带完整掩码的训练样本，用于 Mask‑R‑CNN 网络的精细化分割训练。

### 7.1 Benchmark 要点概括

#### 7.1.1 数据集概况  
- **JPO (341 张图像)**  
  - 来源：日本专利局（Japanese Patent Office）  
  - 特点：绘制风格多样、质量较低、非标准化；去除含缩写的分子  
- **USPTO‑10K‑L (1000 张图像)**  
  - 来源：USPTO‑10K‑L 数据集前 1 000 张大分子图像  
  - 特点：节点数 > 70、无缩写；考察大分子规模下模型表现  
- **USPTO‑Markush (74 张图像)**  
  - 来源：美国专利商标局（USPTO）的 Markush 结构图  
  - 特点：包含可变基团（缩写）和复杂 Markush 结构  

#### 7.1.2 评估指标  
- **Substructure F1‑score (S‑F1)**：子结构检测的查全率与查准率调和平均  
- **Molecule Exact Match (M‑EM)**：当且仅当分子中所有子结构均被正确检测时计为匹配  

#### 7.1.3 方法对比亮点

| 方法             | JPO S‑F1 / M‑EM | USPTO‑10K‑L S‑F1 / M‑EM | USPTO‑Markush S‑F1 / M‑EM |
|------------------|-----------------|------------------------|---------------------------|
| OSRA             | 81 / 67         | **97** / 75            | 74 / 70                   |
| DECIMER          | 86 / 79         | 86 / 66                | 10 / 11                   |
| MolScribe        | **94** / _82_   | 90 / 55                | _86_ / **86**             |
| MolGrapher       | 89 / 80         | 56 / 31                | 35 / 30                   |
| **SubGrapher**   | _92_ / **83**   | **97** / 55            | **88** / _82_             |

- OSRA 在大分子 S‑F1 上最优（97），但 JPO 上 M‑EM 较低。  
- MolScribe 在 JPO S‑F1（94）和 Markush M‑EM（86）上取得最佳成绩。  
- SubGrapher 在 JPO M‑EM (83) 与 Markush S‑F1 (88) 表现优异，且在大分子 S‑F1 与 OSRA 并列最佳，综合稳定。

---

### 7.3 实验评估（Evaluation）

#### 7.3.1 数据集和指标（Datasets & Metrics）
1. **基准分子**  
   - 腺苷（Adenosine）、樟脑（Camphor）、胆固醇（Cholesterol）、柠檬烯（Limonene）、吡啶（Pyridine）  
2. **查询集合构建**  
   - 在 PubChem 检索相似度 ≥ 90% 的 SMILES，随机抽样 500 个，利用 RDKit 渲染图像  
   - 数据增广：平移、缩放、旋转、局部扭曲，模拟真实文档变体  
3. **指纹提取方法对比**  
   - SubGrapher（SVMF）  
   - OSRA + RDKit Daylight  
   - MolScribe + RDKit Daylight  
   - OSRA + MHFP  
   - MolScribe + MHFP  
4. **检索流程**  
   1. 查询：将参考 SMILES 转为指纹  
   2. 匹配：计算与 500 张图像指纹的相似度  
   3. 排序：根据相似度升序，记录真实参考分子平均排名  
5. **指标**  
   - **平均查询排名**：越低越好，表示目标分子在结果中越靠前  

#### 7.3.2 与最先进方法的比较（Results）

| 方法                  | 指纹类型        | 腺苷 | 樟脑 | 胆固醇 | 柠檬烯 | 吡啶 | 平均   |
|-----------------------|-----------------|------|------|--------|--------|------|--------|
| OSRA                  | RDKit Daylight  | 184  | 148  | 165    | 219    | 210  | 185.2  |
| MolScribe             | RDKit Daylight  | 217  | 363  | 149    | 272    | 203  | 240.8  |
| OSRA                  | MHFP            | 139  | 104  | 181    | 152    | 114  | 138.0  |
| MolScribe             | MHFP            | 101  | 287  | 187    | 48     | 283  | 181.2  |
| **SubGrapher (ours)** | **SVMF**         | **110** | **73**  | **106** | **81**  | **103** | **94.6** |

**小结：**  
- SubGrapher 在樟脑、胆固醇、吡啶上排名第一；在腺苷、柠檬烯上排名第二。  
- 平均查询排名 ≈ 95，显著优于其他方法（OSRA+MHFP 平均 138）。  
- 表明在大规模库中，目标分子通常出现在前 100 条以内，满足快速定位需求。
---

## 8 结论（Conclusion）

1. **方法贡献**  
   • 提出了一种端到端的视觉指纹提取方法 SubGrapher，跳过 SMILES 重建，直接从分子图像生成子结构指纹（SVMF）。  
   • 子结构检测 → 子结构图构建 → 指纹生成，一步完成，实现流程简化。  

2. **性能亮点**  
   • 在多个基准分子检索任务中，相较于传统 OCSR + 指纹流水线，SubGrapher 显著提升检索性能（平均排名下降 ∼ 50%+）。  
   • 优异的泛化能力：合成图像训练后，仍能可靠适配真实/增强后的分子图变体。  

3. **潜在应用**  
   • 大规模文献/专利检索：可自动处理海量分子图像，实现子结构与相似分子检索。  
   • 下游预测：SVMF 可直接用作机器学习特征，拓展至性质或活性预测任务。  

4. **未来工作**  
   • 扩展更多类型的子结构（如金属配位中心、非共价相互作用指示符等）。  
   • 优化指纹压缩与加速海量指纹比对。  
   • 在真实专利和论文语料库中部署实证。  